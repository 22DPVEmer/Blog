@using Microsoft.AspNetCore.Identity
@using Blog.Infrastructure.Entities
@model Blog.Infrastructure.Entities.Article
@inject UserManager<User> UserManager

@{
    ViewData["Title"] = "Create Article";
    var currentUser = await UserManager.GetUserAsync(User);
}

<style>
    .drag-drop-zone {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .drag-drop-zone:hover, .drag-drop-zone.dragover {
        border-color: #0d6efd;
        background: #e9ecef;
    }

    .drag-drop-zone .icon {
        font-size: 2rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }

    .image-preview {
        max-height: 300px;
        width: 100%;
        object-fit: cover;
        border-radius: 8px;
        display: none;
    }

    .character-count {
        font-size: 0.875rem;
        color: #6c757d;
        text-align: right;
    }

    .form-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 2rem;
    }

    .progress {
        height: 0.5rem;
        border-radius: 0.25rem;
    }

    .image-preview-container {
        position: relative;
        margin-top: 1rem;
    }

    .image-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 0.5rem;
    }

    .change-image-btn, .remove-image-btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 4px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.875rem;
    }

    .change-image-btn:hover {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .remove-image-btn:hover {
        background: #dc3545;
        color: white;
    }
</style>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="form-container">
                <h1 class="mb-4">Create Article</h1>

                <div id="errorMessages" class="alert alert-danger" style="display: none;"></div>
                <div id="successMessage" class="alert alert-success" style="display: none;"></div>

                <!-- Size indicator -->
                <div class="mb-4">
                    <div class="progress">
                        <div id="sizeProgress" class="progress-bar" role="progressbar" style="width: 0%;" 
                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <small class="text-muted">Total Size: <span id="currentSize">0</span>MB / 10MB</small>
                </div>

                <form id="createArticleForm" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="userId" value="@currentUser?.Id" />

                    <div class="mb-4">
                        <label for="Title" class="form-label">Title</label>
                        <input type="text" class="form-control form-control-lg" id="Title" name="Title" required 
                               placeholder="Enter your article title" />
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-4">
                        <label for="Intro" class="form-label">Intro</label>
                        <textarea class="form-control" id="Intro" name="Intro" rows="3" 
                                maxlength="200" required placeholder="Brief intro of your article"></textarea>
                        <div class="character-count">
                            <span id="introCharCount">0</span>/200 characters
                        </div>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Featured Image (Optional)</label>
                        <div id="dragDropZone" class="drag-drop-zone">
                            <i class="bi bi-cloud-upload icon"></i>
                            <p class="mb-0">Drag and drop your image here or click to select</p>
                            <small class="text-muted d-block mt-2">Supported formats: JPG, PNG, GIF, WEBP (Max 5MB)</small>
                            <input type="file" class="d-none" id="FeaturedImage" name="FeaturedImageFile" accept="image/*" />
                        </div>
                        <div class="image-preview-container">
                            <img id="imagePreview" class="image-preview mt-3" src="#" alt="Preview" />
                            <div class="image-actions" style="display: none;">
                                <button type="button" class="btn btn-light btn-sm change-image-btn" id="changeImageBtn">
                                    <i class="bi bi-pencil"></i> Change
                                </button>
                                <button type="button" class="btn btn-danger btn-sm remove-image-btn" id="removeImageBtn">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="mb-4">
                        <label for="Content" class="form-label">Content</label>
                        <textarea class="form-control" id="Content" name="Content" rows="10" required></textarea>
                        <div class="invalid-feedback"></div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="@Url.Action("Index", "Articles")" class="btn btn-outline-secondary">Back to List</a>
                        <button type="submit" class="btn btn-primary btn-lg" id="submitButton">
                            <i class="bi bi-send"></i> Create Article
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://cdn.tiny.cloud/1/q14zvpfr6i2lsveawxovqvcyooy43cd023rpykgl340ybdw0/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";

        // Initialize Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDWy-qDRV1R42f2ogWMBgMb2rwfwbdnVao",
            authDomain: "blogapp-248d7.firebaseapp.com",
            projectId: "blogapp-248d7",
            storageBucket: "blogapp-248d7.firebasestorage.app",
            messagingSenderId: "341678311816",
            appId: "1:341678311816:web:2132afbc9cb587bc91d23d",
            measurementId: "G-ZSGJ5J1J28"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);

        // Add total size tracking
        let totalSize = 0;
        const MAX_TOTAL_SIZE = 10 * 1024 * 1024; // 10MB in bytes

        function updateSizeDisplay() {
            const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
            const percentage = (totalSize / MAX_TOTAL_SIZE * 100).toFixed(1);
            
            document.getElementById('currentSize').textContent = sizeMB;
            const progressBar = document.getElementById('sizeProgress');
            progressBar.style.width = percentage + '%';
            progressBar.setAttribute('aria-valuenow', percentage);
            progressBar.textContent = percentage + '%';
            
            // Update progress bar color based on usage
            if (percentage > 90) {
                progressBar.classList.remove('bg-success', 'bg-warning');
                progressBar.classList.add('bg-danger');
            } else if (percentage > 70) {
                progressBar.classList.remove('bg-success', 'bg-danger');
                progressBar.classList.add('bg-warning');
            } else {
                progressBar.classList.remove('bg-warning', 'bg-danger');
                progressBar.classList.add('bg-success');
            }
        }

        // Initialize drag and drop functionality
        const dragDropZone = document.getElementById('dragDropZone');
        const fileInput = document.getElementById('FeaturedImage');
        const imagePreview = document.getElementById('imagePreview');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dragDropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dragDropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dragDropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dragDropZone.classList.add('dragover');
        }

        function unhighlight(e) {
            dragDropZone.classList.remove('dragover');
        }

        dragDropZone.addEventListener('drop', handleDrop, false);
        dragDropZone.addEventListener('click', () => fileInput.click());

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile(file);
        }

        fileInput.addEventListener('change', function(e) {
            handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file) return;

            // Check if adding this file would exceed total size limit
            if (totalSize + file.size > MAX_TOTAL_SIZE) {
                showError('Adding this image would exceed the total size limit of 10MB');
                return;
            }

            // Validate file size
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                showError('Featured image size must not exceed 5MB');
                return;
            }

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showError('Only JPG, PNG, GIF, and WEBP images are allowed');
                return;
            }

            // Update total size and preview
            totalSize += file.size;
            updateSizeDisplay();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
                dragDropZone.style.display = 'none';
                document.querySelector('.image-actions').style.display = 'flex';
            }
            reader.readAsDataURL(file);
            
            // Update the file input
            const dT = new DataTransfer();
            dT.items.add(file);
            fileInput.files = dT.files;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessages');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        // Summary character count
        const summaryTextarea = document.getElementById('Intro');
        const charCount = document.getElementById('introCharCount');

        summaryTextarea.addEventListener('input', function() {
            const count = this.value.length;
            charCount.textContent = count;
            
            if (count > 190) {
                charCount.style.color = '#dc3545';
            } else if (count > 180) {
                charCount.style.color = '#ffc107';
            } else {
                charCount.style.color = '#6c757d';
            }
        });

        // Initialize TinyMCE
        tinymce.init({
            selector: '#Content',
            plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount checklist mediaembed casechange export formatpainter pageembed permanentpen footnotes advtemplate advtable advcode editimage tableofcontents powerpaste tinymcespellchecker autocorrect typography inlinecss',
            toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
            height: 500,
            menubar: true,
            // Image upload settings
            image_advtab: true,  // Advanced image options
            image_caption: true,  // Enable image captions
            image_dimensions: false,  // Don't show dimensions in upload dialog
            image_class_list: [  // Image style options
                { title: 'Responsive', value: 'img-fluid' },
                { title: 'Full Width', value: 'img-fluid w-100' },
                { title: 'Centered', value: 'img-fluid mx-auto d-block' }
            ],
            // File picker configuration
            file_picker_types: 'image',
            images_upload_handler: async function (blobInfo, progress) {
                return new Promise((resolve, reject) => {
                    const file = blobInfo.blob();
                    
                    // Check if adding this file would exceed total size limit
                    if (totalSize + file.size > MAX_TOTAL_SIZE) {
                        reject(`Adding this image would exceed the total size limit of 10MB (Current: ${(totalSize / 1024 / 1024).toFixed(2)}MB)`);
                        return;
                    }
                    
                    // Validate file size (5MB limit)
                    const maxSize = 5 * 1024 * 1024; // 5MB in bytes
                    if (file.size > maxSize) {
                        reject('Image size must not exceed 5MB');
                        return;
                    }
                    
                    // Validate file type
                    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (!allowedTypes.includes(file.type)) {
                        reject('Only JPG, PNG, GIF, and WEBP images are allowed');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/Articles/UploadImage');
                    
                    // Add CSRF token
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    xhr.setRequestHeader('RequestVerificationToken', token);
                    
                    // Show upload progress
                    xhr.upload.onprogress = (e) => {
                        progress(e.loaded / e.total * 100);
                    };
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            totalSize = response.currentSize;
                            updateSizeDisplay();
                            resolve(response.imageUrl);
                        } else {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                reject(response.message || 'HTTP Error: ' + xhr.status);
                            } catch {
                                reject('HTTP Error: ' + xhr.status);
                            }
                        }
                    };
                    
                    xhr.onerror = function() {
                        reject('Image upload failed due to a network error.');
                    };
                    
                    xhr.send(formData);
                });
            },
            // Paste image settings
            paste_data_images: true,  // Allow pasting images
            automatic_uploads: true,
            images_reuse_filename: false,
            // Editor setup
            setup: function (editor) {
                editor.on('change', function () {
                    editor.save();
                });

                // Add custom handler for paste to handle clipboard images
                editor.on('paste', function(e) {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            const file = items[i].getAsFile();
                            
                            // Check if adding this file would exceed total size limit
                            if (totalSize + file.size > MAX_TOTAL_SIZE) {
                                editor.notificationManager.open({
                                    text: `Adding this image would exceed the total size limit of 10MB (Current: ${(totalSize / 1024 / 1024).toFixed(2)}MB)`,
                                    type: 'error'
                                });
                                return;
                            }

                            // Validate file size
                            const maxSize = 5 * 1024 * 1024; // 5MB in bytes
                            if (file.size > maxSize) {
                                editor.notificationManager.open({
                                    text: 'Pasted image size must not exceed 5MB',
                                    type: 'error'
                                });
                                return;
                            }

                            // Validate file type
                            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                            if (!allowedTypes.includes(file.type)) {
                                editor.notificationManager.open({
                                    text: 'Only JPG, PNG, GIF, and WEBP images are allowed',
                                    type: 'error'
                                });
                                return;
                            }

                            // Show a loading placeholder
                            const loadingId = 'loading-' + Date.now();
                            editor.insertContent(`<img id="${loadingId}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="loading-placeholder" />`);
                            
                            // Upload the image
                            const formData = new FormData();
                            formData.append('file', file);
                            
                            fetch('/Articles/UploadImage', {
                                method: 'POST',
                                headers: {
                                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                                },
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                // Update total size from server response
                                totalSize = data.currentSize;
                                updateSizeDisplay();
                                
                                // Replace loading placeholder with actual image
                                const img = editor.dom.get(loadingId);
                                if (img) {
                                    editor.dom.setAttrib(img, 'src', data.imageUrl);
                                    editor.dom.setAttrib(img, 'class', 'img-fluid');
                                    editor.dom.setAttrib(img, 'id', '');
                                }
                            })
                            .catch(error => {
                                // Remove loading placeholder if upload fails
                                const img = editor.dom.get(loadingId);
                                if (img) {
                                    editor.dom.remove(img);
                                }
                                editor.notificationManager.open({
                                    text: error.message || 'Failed to upload image',
                                    type: 'error'
                                });
                            });
                        }
                    }
                });
            }
        });

        // Form submission
        document.getElementById('createArticleForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const errorDiv = document.getElementById('errorMessages');
            const successDiv = document.getElementById('successMessage');
            const editor = tinymce.get('Content');
            const featuredImageFile = document.getElementById('FeaturedImage').files[0];

            try {
                submitButton.disabled = true;
                errorDiv.style.display = 'none';
                successDiv.style.display = 'none';

                // Create form data for the entire submission
                const formData = new FormData();
                formData.append('Title', document.getElementById('Title').value);
                formData.append('Intro', document.getElementById('Intro').value);
                formData.append('Content', editor.getContent());
                formData.append('UserId', document.getElementById('userId').value);
                
                // Add featured image if selected
                if (featuredImageFile) {
                    formData.append('FeaturedImageFile', featuredImageFile);
                }

                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const response = await fetch('/Articles/Create', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    },
                    body: formData
                });

                if (response.ok) {
                    successDiv.textContent = 'Article created successfully!';
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = '/Articles';
                    }, 1000);
                } else {
                    const responseData = await response.json();
                    if (response.status === 400 && responseData.errors) {
                        let errorMessage = 'Validation errors:';
                        Object.keys(responseData.errors).forEach(key => {
                            errorMessage += `\n${key}: ${responseData.errors[key].join(', ')}`;
                        });
                        errorDiv.textContent = errorMessage;
                    } else {
                        errorDiv.textContent = responseData.message || 'An error occurred while creating the article.';
                    }
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error creating article:', error);
                errorDiv.textContent = 'An unexpected error occurred. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitButton.disabled = false;
            }
        });

        // Add remove image button functionality
        document.getElementById('removeImageBtn').addEventListener('click', function() {
            document.getElementById('dragDropZone').style.display = 'block';
            document.getElementById('imagePreview').style.display = 'none';
            document.querySelector('.image-actions').style.display = 'none';
            document.getElementById('FeaturedImage').value = '';
            // Reset the preview image source
            document.getElementById('imagePreview').src = '#';
            // Reset total size if needed
            totalSize = 0;
            updateSizeDisplay();
        });

        // Update change image button functionality
        document.getElementById('changeImageBtn').addEventListener('click', function() {
            document.getElementById('dragDropZone').style.display = 'block';
            document.getElementById('imagePreview').style.display = 'none';
            document.querySelector('.image-actions').style.display = 'none';
        });
    </script>
}